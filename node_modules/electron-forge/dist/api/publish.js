'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _bluebird = require('bluebird');

require('colors');

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _oraHandler = require('../util/ora-handler');

var _oraHandler2 = _interopRequireDefault(_oraHandler);

var _forgeConfig = require('../util/forge-config');

var _forgeConfig2 = _interopRequireDefault(_forgeConfig);

var _readPackageJson = require('../util/read-package-json');

var _readPackageJson2 = _interopRequireDefault(_readPackageJson);

var _requireSearch = require('../util/require-search');

var _requireSearch2 = _interopRequireDefault(_requireSearch);

var _resolveDir = require('../util/resolve-dir');

var _resolveDir2 = _interopRequireDefault(_resolveDir);

var _publishState = require('../util/publish-state');

var _publishState2 = _interopRequireDefault(_publishState);

var _make = require('./make');

var _make2 = _interopRequireDefault(_make);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var d = (0, _debug2.default)('electron-forge:publish');

/**
 * @typedef {Object} PublishOptions
 * @property {string} [dir=process.cwd()] The path to the app to be published
 * @property {boolean} [interactive=false] Whether to use sensible defaults or prompt the user visually
 * @property {string} [authToken] An authentication token to use when publishing
 * @property {string} [tag=packageJSON.version] The string to tag this release with
 * @property {Array<string>} [publishTargets=[github]] The publish targets
 * @property {MakeOptions} [makeOptions] Options object to passed through to make()
 * @property {string} [outDir=`${dir}/out`] The path to the directory containing generated distributables
 * @property {boolean} [dryRun=false] Whether to generate dry run meta data but not actually publish
 * @property {boolean} [dryRunResume=false] Whether or not to attempt to resume a previously saved `dryRun` and publish
 * @property {MakeResult} [makeResults=null] Provide results from make so that the publish step doesn't run make itself
 */

/**
 * Publish an Electron application into the given target service.
 *
 * @param {PublishOptions} providedOptions - Options for the Publish method
 * @return {Promise} Will resolve when the publish process is complete
 */
var publish = function () {
  var _ref = (0, _bluebird.coroutine)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {
    var providedOptions = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

    var _Object$assign, dir, interactive, authToken, tag, publishTargets, makeOptions, dryRun, dryRunResume, makeResults, outDir, dryRunDir, packageJSON, forgeConfig, publishes, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, publishStates, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, makeResult, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, makePath, artifacts, _iteratorNormalCompletion4, _didIteratorError4, _iteratorError4, _loop, _iterator4, _step4;

    return _regenerator2.default.wrap(function _callee2$(_context3) {
      while (1) {
        switch (_context3.prev = _context3.next) {
          case 0:
            // eslint-disable-next-line prefer-const, no-unused-vars
            _Object$assign = (0, _assign2.default)({
              dir: process.cwd(),
              interactive: false,
              tag: null,
              makeOptions: {},
              publishTargets: null,
              dryRun: false,
              dryRunResume: false,
              makeResults: null
            }, providedOptions), dir = _Object$assign.dir, interactive = _Object$assign.interactive, authToken = _Object$assign.authToken, tag = _Object$assign.tag, publishTargets = _Object$assign.publishTargets, makeOptions = _Object$assign.makeOptions, dryRun = _Object$assign.dryRun, dryRunResume = _Object$assign.dryRunResume, makeResults = _Object$assign.makeResults;

            _oraHandler2.default.interactive = interactive;

            outDir = providedOptions.outDir || _path2.default.resolve(dir, 'out');
            dryRunDir = _path2.default.resolve(outDir, 'publish-dry-run');

            if (!(dryRun && dryRunResume)) {
              _context3.next = 6;
              break;
            }

            throw 'Can\'t dry run and resume a dry run at the same time';

          case 6:
            if (!(dryRunResume && makeResults)) {
              _context3.next = 8;
              break;
            }

            throw 'Can\'t resume a dry run and use the provided makeResults at the same time';

          case 8:
            _context3.next = 10;
            return (0, _readPackageJson2.default)(dir);

          case 10:
            packageJSON = _context3.sent;
            _context3.next = 13;
            return (0, _forgeConfig2.default)(dir);

          case 13:
            forgeConfig = _context3.sent;

            if (!dryRunResume) {
              _context3.next = 49;
              break;
            }

            d('attempting to resume from dry run');
            _context3.next = 18;
            return _publishState2.default.loadFromDirectory(dryRunDir);

          case 18:
            publishes = _context3.sent;
            _iteratorNormalCompletion = true;
            _didIteratorError = false;
            _iteratorError = undefined;
            _context3.prev = 22;
            _iterator = (0, _getIterator3.default)(publishes);

          case 24:
            if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
              _context3.next = 32;
              break;
            }

            publishStates = _step.value;

            d('publishing for given state set');
            _context3.next = 29;
            return publish({
              dir: dir,
              interactive: interactive,
              authToken: authToken,
              tag: tag,
              publishTargets: publishTargets,
              makeOptions: makeOptions,
              dryRun: false,
              dryRunResume: false,
              makeResults: publishStates.map(function (_ref2) {
                var state = _ref2.state;
                return state;
              })
            });

          case 29:
            _iteratorNormalCompletion = true;
            _context3.next = 24;
            break;

          case 32:
            _context3.next = 38;
            break;

          case 34:
            _context3.prev = 34;
            _context3.t0 = _context3['catch'](22);
            _didIteratorError = true;
            _iteratorError = _context3.t0;

          case 38:
            _context3.prev = 38;
            _context3.prev = 39;

            if (!_iteratorNormalCompletion && _iterator.return) {
              _iterator.return();
            }

          case 41:
            _context3.prev = 41;

            if (!_didIteratorError) {
              _context3.next = 44;
              break;
            }

            throw _iteratorError;

          case 44:
            return _context3.finish(41);

          case 45:
            return _context3.finish(38);

          case 46:
            return _context3.abrupt('return');

          case 49:
            if (makeResults) {
              _context3.next = 56;
              break;
            }

            d('triggering make');
            _context3.next = 53;
            return (0, _make2.default)((0, _assign2.default)({
              dir: dir,
              interactive: interactive
            }, makeOptions));

          case 53:
            makeResults = _context3.sent;
            _context3.next = 112;
            break;

          case 56:
            // Restore values from dry run
            d('restoring publish settings from dry run');

            _iteratorNormalCompletion2 = true;
            _didIteratorError2 = false;
            _iteratorError2 = undefined;
            _context3.prev = 60;
            _iterator2 = (0, _getIterator3.default)(makeResults);

          case 62:
            if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
              _context3.next = 98;
              break;
            }

            makeResult = _step2.value;

            packageJSON = makeResult.packageJSON;
            makeOptions.platform = makeResult.platform;
            makeOptions.arch = makeResult.arch;

            _iteratorNormalCompletion3 = true;
            _didIteratorError3 = false;
            _iteratorError3 = undefined;
            _context3.prev = 70;
            _iterator3 = (0, _getIterator3.default)(makeResult.artifacts);

          case 72:
            if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
              _context3.next = 81;
              break;
            }

            makePath = _step3.value;
            _context3.next = 76;
            return _fsExtra2.default.exists(makePath);

          case 76:
            if (_context3.sent) {
              _context3.next = 78;
              break;
            }

            throw 'Attempted to resume a dry run but an artifact (' + makePath + ') could not be found';

          case 78:
            _iteratorNormalCompletion3 = true;
            _context3.next = 72;
            break;

          case 81:
            _context3.next = 87;
            break;

          case 83:
            _context3.prev = 83;
            _context3.t1 = _context3['catch'](70);
            _didIteratorError3 = true;
            _iteratorError3 = _context3.t1;

          case 87:
            _context3.prev = 87;
            _context3.prev = 88;

            if (!_iteratorNormalCompletion3 && _iterator3.return) {
              _iterator3.return();
            }

          case 90:
            _context3.prev = 90;

            if (!_didIteratorError3) {
              _context3.next = 93;
              break;
            }

            throw _iteratorError3;

          case 93:
            return _context3.finish(90);

          case 94:
            return _context3.finish(87);

          case 95:
            _iteratorNormalCompletion2 = true;
            _context3.next = 62;
            break;

          case 98:
            _context3.next = 104;
            break;

          case 100:
            _context3.prev = 100;
            _context3.t2 = _context3['catch'](60);
            _didIteratorError2 = true;
            _iteratorError2 = _context3.t2;

          case 104:
            _context3.prev = 104;
            _context3.prev = 105;

            if (!_iteratorNormalCompletion2 && _iterator2.return) {
              _iterator2.return();
            }

          case 107:
            _context3.prev = 107;

            if (!_didIteratorError2) {
              _context3.next = 110;
              break;
            }

            throw _iteratorError2;

          case 110:
            return _context3.finish(107);

          case 111:
            return _context3.finish(104);

          case 112:
            if (!dryRun) {
              _context3.next = 119;
              break;
            }

            d('saving results of make in dry run state', makeResults);
            _context3.next = 116;
            return _fsExtra2.default.remove(dryRunDir);

          case 116:
            _context3.next = 118;
            return _publishState2.default.saveToDirectory(dryRunDir, makeResults);

          case 118:
            return _context3.abrupt('return');

          case 119:
            _context3.next = 121;
            return (0, _resolveDir2.default)(dir);

          case 121:
            dir = _context3.sent;

            if (dir) {
              _context3.next = 124;
              break;
            }

            throw 'Failed to locate publishable Electron application';

          case 124:
            artifacts = makeResults.reduce(function (accum, makeResult) {
              accum.push.apply(accum, (0, _toConsumableArray3.default)(makeResult.artifacts));
              return accum;
            }, []);


            if (publishTargets === null) {
              publishTargets = forgeConfig.publish_targets[makeOptions.platform || process.platform];
            }

            _iteratorNormalCompletion4 = true;
            _didIteratorError4 = false;
            _iteratorError4 = undefined;
            _context3.prev = 129;
            _loop = /*#__PURE__*/_regenerator2.default.mark(function _loop() {
              var publishTarget, publisher;
              return _regenerator2.default.wrap(function _loop$(_context2) {
                while (1) {
                  switch (_context2.prev = _context2.next) {
                    case 0:
                      publishTarget = _step4.value;
                      publisher = void 0;
                      _context2.next = 4;
                      return (0, _oraHandler2.default)('Resolving publish target: ' + ('' + publishTarget).cyan, (0, _bluebird.coroutine)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {
                        return _regenerator2.default.wrap(function _callee$(_context) {
                          while (1) {
                            switch (_context.prev = _context.next) {
                              case 0:
                                // eslint-disable-line no-loop-func
                                publisher = (0, _requireSearch2.default)(__dirname, ['../publishers/' + publishTarget + '.js', 'electron-forge-publisher-' + publishTarget, publishTarget, _path2.default.resolve(dir, publishTarget), _path2.default.resolve(dir, 'node_modules', publishTarget)]);

                                if (publisher) {
                                  _context.next = 3;
                                  break;
                                }

                                throw 'Could not find a publish target with the name: ' + publishTarget;

                              case 3:
                              case 'end':
                                return _context.stop();
                            }
                          }
                        }, _callee, undefined);
                      })));

                    case 4:
                      _context2.next = 6;
                      return publisher(artifacts, packageJSON, forgeConfig, authToken, tag, makeOptions.platform || process.platform, makeOptions.arch || process.arch);

                    case 6:
                    case 'end':
                      return _context2.stop();
                  }
                }
              }, _loop, undefined);
            });
            _iterator4 = (0, _getIterator3.default)(publishTargets);

          case 132:
            if (_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done) {
              _context3.next = 137;
              break;
            }

            return _context3.delegateYield(_loop(), 't3', 134);

          case 134:
            _iteratorNormalCompletion4 = true;
            _context3.next = 132;
            break;

          case 137:
            _context3.next = 143;
            break;

          case 139:
            _context3.prev = 139;
            _context3.t4 = _context3['catch'](129);
            _didIteratorError4 = true;
            _iteratorError4 = _context3.t4;

          case 143:
            _context3.prev = 143;
            _context3.prev = 144;

            if (!_iteratorNormalCompletion4 && _iterator4.return) {
              _iterator4.return();
            }

          case 146:
            _context3.prev = 146;

            if (!_didIteratorError4) {
              _context3.next = 149;
              break;
            }

            throw _iteratorError4;

          case 149:
            return _context3.finish(146);

          case 150:
            return _context3.finish(143);

          case 151:
          case 'end':
            return _context3.stop();
        }
      }
    }, _callee2, undefined, [[22, 34, 38, 46], [39,, 41, 45], [60, 100, 104, 112], [70, 83, 87, 95], [88,, 90, 94], [105,, 107, 111], [129, 139, 143, 151], [144,, 146, 150]]);
  }));

  return function publish() {
    return _ref.apply(this, arguments);
  };
}();

exports.default = publish;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwaS9wdWJsaXNoLmpzIl0sIm5hbWVzIjpbImQiLCJwdWJsaXNoIiwicHJvdmlkZWRPcHRpb25zIiwiZGlyIiwicHJvY2VzcyIsImN3ZCIsImludGVyYWN0aXZlIiwidGFnIiwibWFrZU9wdGlvbnMiLCJwdWJsaXNoVGFyZ2V0cyIsImRyeVJ1biIsImRyeVJ1blJlc3VtZSIsIm1ha2VSZXN1bHRzIiwiYXV0aFRva2VuIiwib3V0RGlyIiwicmVzb2x2ZSIsImRyeVJ1bkRpciIsInBhY2thZ2VKU09OIiwiZm9yZ2VDb25maWciLCJsb2FkRnJvbURpcmVjdG9yeSIsInB1Ymxpc2hlcyIsInB1Ymxpc2hTdGF0ZXMiLCJtYXAiLCJzdGF0ZSIsIm1ha2VSZXN1bHQiLCJwbGF0Zm9ybSIsImFyY2giLCJhcnRpZmFjdHMiLCJtYWtlUGF0aCIsImV4aXN0cyIsInJlbW92ZSIsInNhdmVUb0RpcmVjdG9yeSIsInJlZHVjZSIsImFjY3VtIiwicHVzaCIsInB1Ymxpc2hfdGFyZ2V0cyIsInB1Ymxpc2hUYXJnZXQiLCJwdWJsaXNoZXIiLCJjeWFuIiwiX19kaXJuYW1lIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7Ozs7O0FBRUEsSUFBTUEsSUFBSSxxQkFBTSx3QkFBTixDQUFWOztBQUVBOzs7Ozs7Ozs7Ozs7OztBQWNBOzs7Ozs7QUFNQSxJQUFNQztBQUFBLCtFQUFVO0FBQUEsUUFBT0MsZUFBUCx1RUFBeUIsRUFBekI7O0FBQUE7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFDZDtBQURjLDZCQUU2RixzQkFBYztBQUN2SEMsbUJBQUtDLFFBQVFDLEdBQVIsRUFEa0g7QUFFdkhDLDJCQUFhLEtBRjBHO0FBR3ZIQyxtQkFBSyxJQUhrSDtBQUl2SEMsMkJBQWEsRUFKMEc7QUFLdkhDLDhCQUFnQixJQUx1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QUFBQTtBQUFBO0FBQUE7O0FBQUE7QUFBQTtBQUFBOztBQUFBO0FBQUE7O0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBQUE7O0FBQUE7QUFBQTs7QUFBQTtBQUFBOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEdBQVY7O0FBQUE7QUFBQTtBQUFBO0FBQUEsR0FBTjs7a0JBNkdlUixPIiwiZmlsZSI6ImFwaS9wdWJsaXNoLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICdjb2xvcnMnO1xuaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IGFzeW5jT3JhIGZyb20gJy4uL3V0aWwvb3JhLWhhbmRsZXInO1xuaW1wb3J0IGdldEZvcmdlQ29uZmlnIGZyb20gJy4uL3V0aWwvZm9yZ2UtY29uZmlnJztcbmltcG9ydCByZWFkUGFja2FnZUpTT04gZnJvbSAnLi4vdXRpbC9yZWFkLXBhY2thZ2UtanNvbic7XG5pbXBvcnQgcmVxdWlyZVNlYXJjaCBmcm9tICcuLi91dGlsL3JlcXVpcmUtc2VhcmNoJztcbmltcG9ydCByZXNvbHZlRGlyIGZyb20gJy4uL3V0aWwvcmVzb2x2ZS1kaXInO1xuaW1wb3J0IFB1Ymxpc2hTdGF0ZSBmcm9tICcuLi91dGlsL3B1Ymxpc2gtc3RhdGUnO1xuXG5pbXBvcnQgbWFrZSBmcm9tICcuL21ha2UnO1xuXG5jb25zdCBkID0gZGVidWcoJ2VsZWN0cm9uLWZvcmdlOnB1Ymxpc2gnKTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBQdWJsaXNoT3B0aW9uc1xuICogQHByb3BlcnR5IHtzdHJpbmd9IFtkaXI9cHJvY2Vzcy5jd2QoKV0gVGhlIHBhdGggdG8gdGhlIGFwcCB0byBiZSBwdWJsaXNoZWRcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW2ludGVyYWN0aXZlPWZhbHNlXSBXaGV0aGVyIHRvIHVzZSBzZW5zaWJsZSBkZWZhdWx0cyBvciBwcm9tcHQgdGhlIHVzZXIgdmlzdWFsbHlcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbYXV0aFRva2VuXSBBbiBhdXRoZW50aWNhdGlvbiB0b2tlbiB0byB1c2Ugd2hlbiBwdWJsaXNoaW5nXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW3RhZz1wYWNrYWdlSlNPTi52ZXJzaW9uXSBUaGUgc3RyaW5nIHRvIHRhZyB0aGlzIHJlbGVhc2Ugd2l0aFxuICogQHByb3BlcnR5IHtBcnJheTxzdHJpbmc+fSBbcHVibGlzaFRhcmdldHM9W2dpdGh1Yl1dIFRoZSBwdWJsaXNoIHRhcmdldHNcbiAqIEBwcm9wZXJ0eSB7TWFrZU9wdGlvbnN9IFttYWtlT3B0aW9uc10gT3B0aW9ucyBvYmplY3QgdG8gcGFzc2VkIHRocm91Z2ggdG8gbWFrZSgpXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW291dERpcj1gJHtkaXJ9L291dGBdIFRoZSBwYXRoIHRvIHRoZSBkaXJlY3RvcnkgY29udGFpbmluZyBnZW5lcmF0ZWQgZGlzdHJpYnV0YWJsZXNcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW2RyeVJ1bj1mYWxzZV0gV2hldGhlciB0byBnZW5lcmF0ZSBkcnkgcnVuIG1ldGEgZGF0YSBidXQgbm90IGFjdHVhbGx5IHB1Ymxpc2hcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW2RyeVJ1blJlc3VtZT1mYWxzZV0gV2hldGhlciBvciBub3QgdG8gYXR0ZW1wdCB0byByZXN1bWUgYSBwcmV2aW91c2x5IHNhdmVkIGBkcnlSdW5gIGFuZCBwdWJsaXNoXG4gKiBAcHJvcGVydHkge01ha2VSZXN1bHR9IFttYWtlUmVzdWx0cz1udWxsXSBQcm92aWRlIHJlc3VsdHMgZnJvbSBtYWtlIHNvIHRoYXQgdGhlIHB1Ymxpc2ggc3RlcCBkb2Vzbid0IHJ1biBtYWtlIGl0c2VsZlxuICovXG5cbi8qKlxuICogUHVibGlzaCBhbiBFbGVjdHJvbiBhcHBsaWNhdGlvbiBpbnRvIHRoZSBnaXZlbiB0YXJnZXQgc2VydmljZS5cbiAqXG4gKiBAcGFyYW0ge1B1Ymxpc2hPcHRpb25zfSBwcm92aWRlZE9wdGlvbnMgLSBPcHRpb25zIGZvciB0aGUgUHVibGlzaCBtZXRob2RcbiAqIEByZXR1cm4ge1Byb21pc2V9IFdpbGwgcmVzb2x2ZSB3aGVuIHRoZSBwdWJsaXNoIHByb2Nlc3MgaXMgY29tcGxldGVcbiAqL1xuY29uc3QgcHVibGlzaCA9IGFzeW5jIChwcm92aWRlZE9wdGlvbnMgPSB7fSkgPT4ge1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLWNvbnN0LCBuby11bnVzZWQtdmFyc1xuICBsZXQgeyBkaXIsIGludGVyYWN0aXZlLCBhdXRoVG9rZW4sIHRhZywgcHVibGlzaFRhcmdldHMsIG1ha2VPcHRpb25zLCBkcnlSdW4sIGRyeVJ1blJlc3VtZSwgbWFrZVJlc3VsdHMgfSA9IE9iamVjdC5hc3NpZ24oe1xuICAgIGRpcjogcHJvY2Vzcy5jd2QoKSxcbiAgICBpbnRlcmFjdGl2ZTogZmFsc2UsXG4gICAgdGFnOiBudWxsLFxuICAgIG1ha2VPcHRpb25zOiB7fSxcbiAgICBwdWJsaXNoVGFyZ2V0czogbnVsbCxcbiAgICBkcnlSdW46IGZhbHNlLFxuICAgIGRyeVJ1blJlc3VtZTogZmFsc2UsXG4gICAgbWFrZVJlc3VsdHM6IG51bGwsXG4gIH0sIHByb3ZpZGVkT3B0aW9ucyk7XG4gIGFzeW5jT3JhLmludGVyYWN0aXZlID0gaW50ZXJhY3RpdmU7XG5cbiAgY29uc3Qgb3V0RGlyID0gcHJvdmlkZWRPcHRpb25zLm91dERpciB8fCBwYXRoLnJlc29sdmUoZGlyLCAnb3V0Jyk7XG4gIGNvbnN0IGRyeVJ1bkRpciA9IHBhdGgucmVzb2x2ZShvdXREaXIsICdwdWJsaXNoLWRyeS1ydW4nKTtcblxuICBpZiAoZHJ5UnVuICYmIGRyeVJ1blJlc3VtZSkge1xuICAgIHRocm93ICdDYW5cXCd0IGRyeSBydW4gYW5kIHJlc3VtZSBhIGRyeSBydW4gYXQgdGhlIHNhbWUgdGltZSc7XG4gIH1cbiAgaWYgKGRyeVJ1blJlc3VtZSAmJiBtYWtlUmVzdWx0cykge1xuICAgIHRocm93ICdDYW5cXCd0IHJlc3VtZSBhIGRyeSBydW4gYW5kIHVzZSB0aGUgcHJvdmlkZWQgbWFrZVJlc3VsdHMgYXQgdGhlIHNhbWUgdGltZSc7XG4gIH1cblxuICBsZXQgcGFja2FnZUpTT04gPSBhd2FpdCByZWFkUGFja2FnZUpTT04oZGlyKTtcblxuICBjb25zdCBmb3JnZUNvbmZpZyA9IGF3YWl0IGdldEZvcmdlQ29uZmlnKGRpcik7XG5cbiAgaWYgKGRyeVJ1blJlc3VtZSkge1xuICAgIGQoJ2F0dGVtcHRpbmcgdG8gcmVzdW1lIGZyb20gZHJ5IHJ1bicpO1xuICAgIGNvbnN0IHB1Ymxpc2hlcyA9IGF3YWl0IFB1Ymxpc2hTdGF0ZS5sb2FkRnJvbURpcmVjdG9yeShkcnlSdW5EaXIpO1xuICAgIGZvciAoY29uc3QgcHVibGlzaFN0YXRlcyBvZiBwdWJsaXNoZXMpIHtcbiAgICAgIGQoJ3B1Ymxpc2hpbmcgZm9yIGdpdmVuIHN0YXRlIHNldCcpO1xuICAgICAgYXdhaXQgcHVibGlzaCh7XG4gICAgICAgIGRpcixcbiAgICAgICAgaW50ZXJhY3RpdmUsXG4gICAgICAgIGF1dGhUb2tlbixcbiAgICAgICAgdGFnLFxuICAgICAgICBwdWJsaXNoVGFyZ2V0cyxcbiAgICAgICAgbWFrZU9wdGlvbnMsXG4gICAgICAgIGRyeVJ1bjogZmFsc2UsXG4gICAgICAgIGRyeVJ1blJlc3VtZTogZmFsc2UsXG4gICAgICAgIG1ha2VSZXN1bHRzOiBwdWJsaXNoU3RhdGVzLm1hcCgoeyBzdGF0ZSB9KSA9PiBzdGF0ZSksXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuO1xuICB9IGVsc2UgaWYgKCFtYWtlUmVzdWx0cykge1xuICAgIGQoJ3RyaWdnZXJpbmcgbWFrZScpO1xuICAgIG1ha2VSZXN1bHRzID0gYXdhaXQgbWFrZShPYmplY3QuYXNzaWduKHtcbiAgICAgIGRpcixcbiAgICAgIGludGVyYWN0aXZlLFxuICAgIH0sIG1ha2VPcHRpb25zKSk7XG4gIH0gZWxzZSB7XG4gICAgLy8gUmVzdG9yZSB2YWx1ZXMgZnJvbSBkcnkgcnVuXG4gICAgZCgncmVzdG9yaW5nIHB1Ymxpc2ggc2V0dGluZ3MgZnJvbSBkcnkgcnVuJyk7XG5cbiAgICBmb3IgKGNvbnN0IG1ha2VSZXN1bHQgb2YgbWFrZVJlc3VsdHMpIHtcbiAgICAgIHBhY2thZ2VKU09OID0gbWFrZVJlc3VsdC5wYWNrYWdlSlNPTjtcbiAgICAgIG1ha2VPcHRpb25zLnBsYXRmb3JtID0gbWFrZVJlc3VsdC5wbGF0Zm9ybTtcbiAgICAgIG1ha2VPcHRpb25zLmFyY2ggPSBtYWtlUmVzdWx0LmFyY2g7XG5cbiAgICAgIGZvciAoY29uc3QgbWFrZVBhdGggb2YgbWFrZVJlc3VsdC5hcnRpZmFjdHMpIHtcbiAgICAgICAgaWYgKCFhd2FpdCBmcy5leGlzdHMobWFrZVBhdGgpKSB7XG4gICAgICAgICAgdGhyb3cgYEF0dGVtcHRlZCB0byByZXN1bWUgYSBkcnkgcnVuIGJ1dCBhbiBhcnRpZmFjdCAoJHttYWtlUGF0aH0pIGNvdWxkIG5vdCBiZSBmb3VuZGA7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpZiAoZHJ5UnVuKSB7XG4gICAgZCgnc2F2aW5nIHJlc3VsdHMgb2YgbWFrZSBpbiBkcnkgcnVuIHN0YXRlJywgbWFrZVJlc3VsdHMpO1xuICAgIGF3YWl0IGZzLnJlbW92ZShkcnlSdW5EaXIpO1xuICAgIGF3YWl0IFB1Ymxpc2hTdGF0ZS5zYXZlVG9EaXJlY3RvcnkoZHJ5UnVuRGlyLCBtYWtlUmVzdWx0cyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgZGlyID0gYXdhaXQgcmVzb2x2ZURpcihkaXIpO1xuICBpZiAoIWRpcikge1xuICAgIHRocm93ICdGYWlsZWQgdG8gbG9jYXRlIHB1Ymxpc2hhYmxlIEVsZWN0cm9uIGFwcGxpY2F0aW9uJztcbiAgfVxuXG4gIGNvbnN0IGFydGlmYWN0cyA9IG1ha2VSZXN1bHRzLnJlZHVjZSgoYWNjdW0sIG1ha2VSZXN1bHQpID0+IHtcbiAgICBhY2N1bS5wdXNoKC4uLm1ha2VSZXN1bHQuYXJ0aWZhY3RzKTtcbiAgICByZXR1cm4gYWNjdW07XG4gIH0sIFtdKTtcblxuICBpZiAocHVibGlzaFRhcmdldHMgPT09IG51bGwpIHtcbiAgICBwdWJsaXNoVGFyZ2V0cyA9IGZvcmdlQ29uZmlnLnB1Ymxpc2hfdGFyZ2V0c1ttYWtlT3B0aW9ucy5wbGF0Zm9ybSB8fCBwcm9jZXNzLnBsYXRmb3JtXTtcbiAgfVxuXG4gIGZvciAoY29uc3QgcHVibGlzaFRhcmdldCBvZiBwdWJsaXNoVGFyZ2V0cykge1xuICAgIGxldCBwdWJsaXNoZXI7XG4gICAgYXdhaXQgYXN5bmNPcmEoYFJlc29sdmluZyBwdWJsaXNoIHRhcmdldDogJHtgJHtwdWJsaXNoVGFyZ2V0fWAuY3lhbn1gLCBhc3luYyAoKSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbG9vcC1mdW5jXG4gICAgICBwdWJsaXNoZXIgPSByZXF1aXJlU2VhcmNoKF9fZGlybmFtZSwgW1xuICAgICAgICBgLi4vcHVibGlzaGVycy8ke3B1Ymxpc2hUYXJnZXR9LmpzYCxcbiAgICAgICAgYGVsZWN0cm9uLWZvcmdlLXB1Ymxpc2hlci0ke3B1Ymxpc2hUYXJnZXR9YCxcbiAgICAgICAgcHVibGlzaFRhcmdldCxcbiAgICAgICAgcGF0aC5yZXNvbHZlKGRpciwgcHVibGlzaFRhcmdldCksXG4gICAgICAgIHBhdGgucmVzb2x2ZShkaXIsICdub2RlX21vZHVsZXMnLCBwdWJsaXNoVGFyZ2V0KSxcbiAgICAgIF0pO1xuICAgICAgaWYgKCFwdWJsaXNoZXIpIHtcbiAgICAgICAgdGhyb3cgYENvdWxkIG5vdCBmaW5kIGEgcHVibGlzaCB0YXJnZXQgd2l0aCB0aGUgbmFtZTogJHtwdWJsaXNoVGFyZ2V0fWA7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBhd2FpdCBwdWJsaXNoZXIoYXJ0aWZhY3RzLCBwYWNrYWdlSlNPTiwgZm9yZ2VDb25maWcsIGF1dGhUb2tlbiwgdGFnLCBtYWtlT3B0aW9ucy5wbGF0Zm9ybSB8fCBwcm9jZXNzLnBsYXRmb3JtLCBtYWtlT3B0aW9ucy5hcmNoIHx8IHByb2Nlc3MuYXJjaCk7XG4gIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IHB1Ymxpc2g7XG4iXX0=
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createDefaultCertificate = exports.isSupportedOnCurrentPlatform = undefined;

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _bluebird = require('bluebird');

var createDefaultCertificate = exports.createDefaultCertificate = function () {
  var _ref2 = (0, _bluebird.coroutine)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(publisherName, _ref3) {
    var certFilePath = _ref3.certFilePath,
        certFileName = _ref3.certFileName,
        install = _ref3.install,
        program = _ref3.program;
    var makeCertOptions;
    return _regenerator2.default.wrap(function _callee2$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            makeCertOptions = {
              publisherName: publisherName,
              certFilePath: certFilePath || process.cwd(),
              certFileName: certFileName || 'default',
              install: typeof install === 'boolean' ? install : false,
              program: program || { windowsKit: _path2.default.dirname(findSdkTool('makecert.exe')) }
            };

            if ((0, _sign.isValidPublisherName)(publisherName)) {
              _context2.next = 3;
              break;
            }

            throw new Error('Received invalid publisher name: \'' + publisherName + '\' did not conform to X.500 distinguished name syntax for MakeCert.');

          case 3:
            _context2.next = 5;
            return (0, _sign.makeCert)(makeCertOptions);

          case 5:
            return _context2.abrupt('return', _context2.sent);

          case 6:
          case 'end':
            return _context2.stop();
        }
      }
    }, _callee2, this);
  }));

  return function createDefaultCertificate(_x, _x2) {
    return _ref2.apply(this, arguments);
  };
}();

exports.getDistinguishedNameFromAuthor = getDistinguishedNameFromAuthor;

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _parseAuthor = require('parse-author');

var _parseAuthor2 = _interopRequireDefault(_parseAuthor);

var _electronWindowsStore = require('electron-windows-store');

var _electronWindowsStore2 = _interopRequireDefault(_electronWindowsStore);

var _sign = require('electron-windows-store/lib/sign');

var _resolveCommand = require('cross-spawn/lib/util/resolveCommand');

var _resolveCommand2 = _interopRequireDefault(_resolveCommand);

var _ensureOutput = require('../../util/ensure-output');

var _configFn = require('../../util/config-fn');

var _configFn2 = _interopRequireDefault(_configFn);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// electron-windows-store doesn't set its 'os' field even though it only runs on
// win32
var isSupportedOnCurrentPlatform = exports.isSupportedOnCurrentPlatform = function () {
  var _ref = (0, _bluebird.coroutine)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {
    return _regenerator2.default.wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            return _context.abrupt('return', process.platform === 'win32');

          case 1:
          case 'end':
            return _context.stop();
        }
      }
    }, _callee, undefined);
  }));

  return function isSupportedOnCurrentPlatform() {
    return _ref.apply(this, arguments);
  };
}();

// NB: This is not a typo, we require AppXs to be built on 64-bit
// but if we're running in a 32-bit node.js process, we're going to
// be Wow64 redirected
var windowsSdkPath = process.arch === 'x64' ? 'C:\\Program Files (x86)\\Windows Kits\\10\\bin\\x64' : 'C:\\Program Files\\Windows Kits\\10\\bin\\x64';

function findSdkTool(exe) {
  var sdkTool = _path2.default.join(windowsSdkPath, exe);
  if (!_fs2.default.existsSync(sdkTool)) {
    sdkTool = (0, _resolveCommand2.default)(exe, true);
  }

  if (!_fs2.default.existsSync(sdkTool)) {
    throw new Error('Can\'t find ' + exe + ' in PATH. You probably need to install the Windows SDK.');
  }

  return sdkTool;
}

function getDistinguishedNameFromAuthor(author) {
  var publisher = author || '';

  if (typeof publisher === 'string') {
    publisher = (0, _parseAuthor2.default)(publisher);
  }

  if (typeof publisher.name === 'string') {
    publisher = publisher.name;
  }

  if (typeof publisher !== 'string') {
    publisher = '';
  }

  return 'CN=' + publisher;
}

exports.default = function () {
  var _ref4 = (0, _bluebird.coroutine)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(_ref5) {
    var dir = _ref5.dir,
        appName = _ref5.appName,
        targetArch = _ref5.targetArch,
        forgeConfig = _ref5.forgeConfig,
        packageJSON = _ref5.packageJSON;
    var outPath, userConfig, opts, noBeta, err;
    return _regenerator2.default.wrap(function _callee3$(_context3) {
      while (1) {
        switch (_context3.prev = _context3.next) {
          case 0:
            outPath = _path2.default.resolve(dir, '../make/appx/' + targetArch);
            _context3.next = 3;
            return (0, _ensureOutput.ensureDirectory)(outPath);

          case 3:
            userConfig = (0, _configFn2.default)(forgeConfig.windowsStoreConfig, targetArch);
            opts = (0, _assign2.default)({
              publisher: getDistinguishedNameFromAuthor(packageJSON.author),
              flatten: false,
              deploy: false,
              packageVersion: packageJSON.version + '.0',
              packageName: appName.replace(/-/g, ''),
              packageDisplayName: appName,
              packageDescription: packageJSON.description || appName,
              packageExecutable: 'app\\' + appName + '.exe',
              windowsKit: userConfig.windowsKit || _path2.default.dirname(findSdkTool('makeappx.exe'))
            }, userConfig, {
              inputDirectory: dir,
              outputDirectory: outPath
            });

            if (opts.publisher) {
              _context3.next = 7;
              break;
            }

            throw 'Please set config.forge.windowsStoreConfig.publisher or author.name in package.json for the appx target';

          case 7:
            if (opts.devCert) {
              _context3.next = 11;
              break;
            }

            _context3.next = 10;
            return createDefaultCertificate(opts.publisher, { certFilePath: outPath, program: opts });

          case 10:
            opts.devCert = _context3.sent;

          case 11:
            if (!opts.packageVersion.match(/-/)) {
              _context3.next = 19;
              break;
            }

            if (!opts.makeVersionWinStoreCompatible) {
              _context3.next = 17;
              break;
            }

            noBeta = opts.packageVersion.replace(/-.*/, '');

            opts.packageVersion = noBeta + '.0';
            _context3.next = 19;
            break;

          case 17:
            err = "Windows Store version numbers don't support semver beta tags. To" + 'automatically fix this, set makeVersionWinStoreCompatible to true or ' + 'explicitly set packageVersion to a version of the format X.Y.Z.A';
            throw new Error(err);

          case 19:

            delete opts.makeVersionWinStoreCompatible;

            _context3.next = 22;
            return (0, _electronWindowsStore2.default)(opts);

          case 22:
            return _context3.abrupt('return', [_path2.default.resolve(outPath, opts.packageName + '.appx')]);

          case 23:
          case 'end':
            return _context3.stop();
        }
      }
    }, _callee3, undefined);
  }));

  return function (_x3) {
    return _ref4.apply(this, arguments);
  };
}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1ha2Vycy93aW4zMi9hcHB4LmpzIl0sIm5hbWVzIjpbInB1Ymxpc2hlck5hbWUiLCJjZXJ0RmlsZVBhdGgiLCJjZXJ0RmlsZU5hbWUiLCJpbnN0YWxsIiwicHJvZ3JhbSIsIm1ha2VDZXJ0T3B0aW9ucyIsInByb2Nlc3MiLCJjd2QiLCJ3aW5kb3dzS2l0IiwiZGlybmFtZSIsImZpbmRTZGtUb29sIiwiRXJyb3IiLCJjcmVhdGVEZWZhdWx0Q2VydGlmaWNhdGUiLCJnZXREaXN0aW5ndWlzaGVkTmFtZUZyb21BdXRob3IiLCJpc1N1cHBvcnRlZE9uQ3VycmVudFBsYXRmb3JtIiwicGxhdGZvcm0iLCJ3aW5kb3dzU2RrUGF0aCIsImFyY2giLCJleGUiLCJzZGtUb29sIiwiam9pbiIsImV4aXN0c1N5bmMiLCJhdXRob3IiLCJwdWJsaXNoZXIiLCJuYW1lIiwiZGlyIiwiYXBwTmFtZSIsInRhcmdldEFyY2giLCJmb3JnZUNvbmZpZyIsInBhY2thZ2VKU09OIiwib3V0UGF0aCIsInJlc29sdmUiLCJ1c2VyQ29uZmlnIiwid2luZG93c1N0b3JlQ29uZmlnIiwib3B0cyIsImZsYXR0ZW4iLCJkZXBsb3kiLCJwYWNrYWdlVmVyc2lvbiIsInZlcnNpb24iLCJwYWNrYWdlTmFtZSIsInJlcGxhY2UiLCJwYWNrYWdlRGlzcGxheU5hbWUiLCJwYWNrYWdlRGVzY3JpcHRpb24iLCJkZXNjcmlwdGlvbiIsInBhY2thZ2VFeGVjdXRhYmxlIiwiaW5wdXREaXJlY3RvcnkiLCJvdXRwdXREaXJlY3RvcnkiLCJkZXZDZXJ0IiwibWF0Y2giLCJtYWtlVmVyc2lvbldpblN0b3JlQ29tcGF0aWJsZSIsIm5vQmV0YSIsImVyciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O2dGQWtDTyxrQkFBd0NBLGFBQXhDO0FBQUEsUUFBeURDLFlBQXpELFNBQXlEQSxZQUF6RDtBQUFBLFFBQXVFQyxZQUF2RSxTQUF1RUEsWUFBdkU7QUFBQSxRQUFxRkMsT0FBckYsU0FBcUZBLE9BQXJG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a0JBc0NILElBQUl4QyxLQUFKLENBQVV3QyxHQUFWLENBdENHOztBQUFBOztBQTBDYixtQkFBT2pCLEtBQUtlLDZCQUFaOztBQTFDYTtBQUFBLG1CQTRDUCxvQ0FBYWYsSUFBYixDQTVDTzs7QUFBQTtBQUFBLDhDQThDTixDQUFDLGVBQUtILE9BQUwsQ0FBYUQsT0FBYixFQUF5QkksS0FBS0ssV0FBOUIsV0FBRCxDQTlDTTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxHIiwiZmlsZSI6Im1ha2Vycy93aW4zMi9hcHB4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHBhcnNlQXV0aG9yIGZyb20gJ3BhcnNlLWF1dGhvcic7XG5pbXBvcnQgd2luZG93c1N0b3JlIGZyb20gJ2VsZWN0cm9uLXdpbmRvd3Mtc3RvcmUnO1xuaW1wb3J0IHsgaXNWYWxpZFB1Ymxpc2hlck5hbWUsIG1ha2VDZXJ0IH0gZnJvbSAnZWxlY3Ryb24td2luZG93cy1zdG9yZS9saWIvc2lnbic7XG5cbmltcG9ydCByZXNvbHZlQ29tbWFuZCBmcm9tICdjcm9zcy1zcGF3bi9saWIvdXRpbC9yZXNvbHZlQ29tbWFuZCc7XG5pbXBvcnQgeyBlbnN1cmVEaXJlY3RvcnkgfSBmcm9tICcuLi8uLi91dGlsL2Vuc3VyZS1vdXRwdXQnO1xuaW1wb3J0IGNvbmZpZ0ZuIGZyb20gJy4uLy4uL3V0aWwvY29uZmlnLWZuJztcblxuLy8gZWxlY3Ryb24td2luZG93cy1zdG9yZSBkb2Vzbid0IHNldCBpdHMgJ29zJyBmaWVsZCBldmVuIHRob3VnaCBpdCBvbmx5IHJ1bnMgb25cbi8vIHdpbjMyXG5leHBvcnQgY29uc3QgaXNTdXBwb3J0ZWRPbkN1cnJlbnRQbGF0Zm9ybSA9IGFzeW5jICgpID0+IHByb2Nlc3MucGxhdGZvcm0gPT09ICd3aW4zMic7XG5cbi8vIE5COiBUaGlzIGlzIG5vdCBhIHR5cG8sIHdlIHJlcXVpcmUgQXBwWHMgdG8gYmUgYnVpbHQgb24gNjQtYml0XG4vLyBidXQgaWYgd2UncmUgcnVubmluZyBpbiBhIDMyLWJpdCBub2RlLmpzIHByb2Nlc3MsIHdlJ3JlIGdvaW5nIHRvXG4vLyBiZSBXb3c2NCByZWRpcmVjdGVkXG5jb25zdCB3aW5kb3dzU2RrUGF0aCA9IHByb2Nlc3MuYXJjaCA9PT0gJ3g2NCcgP1xuICAnQzpcXFxcUHJvZ3JhbSBGaWxlcyAoeDg2KVxcXFxXaW5kb3dzIEtpdHNcXFxcMTBcXFxcYmluXFxcXHg2NCcgOlxuICAnQzpcXFxcUHJvZ3JhbSBGaWxlc1xcXFxXaW5kb3dzIEtpdHNcXFxcMTBcXFxcYmluXFxcXHg2NCc7XG5cbmZ1bmN0aW9uIGZpbmRTZGtUb29sKGV4ZSkge1xuICBsZXQgc2RrVG9vbCA9IHBhdGguam9pbih3aW5kb3dzU2RrUGF0aCwgZXhlKTtcbiAgaWYgKCFmcy5leGlzdHNTeW5jKHNka1Rvb2wpKSB7XG4gICAgc2RrVG9vbCA9IHJlc29sdmVDb21tYW5kKGV4ZSwgdHJ1ZSk7XG4gIH1cblxuICBpZiAoIWZzLmV4aXN0c1N5bmMoc2RrVG9vbCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbid0IGZpbmQgJHtleGV9IGluIFBBVEguIFlvdSBwcm9iYWJseSBuZWVkIHRvIGluc3RhbGwgdGhlIFdpbmRvd3MgU0RLLmApO1xuICB9XG5cbiAgcmV0dXJuIHNka1Rvb2w7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVEZWZhdWx0Q2VydGlmaWNhdGUocHVibGlzaGVyTmFtZSwgeyBjZXJ0RmlsZVBhdGgsIGNlcnRGaWxlTmFtZSwgaW5zdGFsbCwgcHJvZ3JhbSB9KSB7XG4gIGNvbnN0IG1ha2VDZXJ0T3B0aW9ucyA9IHtcbiAgICBwdWJsaXNoZXJOYW1lLFxuICAgIGNlcnRGaWxlUGF0aDogY2VydEZpbGVQYXRoIHx8IHByb2Nlc3MuY3dkKCksXG4gICAgY2VydEZpbGVOYW1lOiBjZXJ0RmlsZU5hbWUgfHwgJ2RlZmF1bHQnLFxuICAgIGluc3RhbGw6IHR5cGVvZiBpbnN0YWxsID09PSAnYm9vbGVhbicgPyBpbnN0YWxsIDogZmFsc2UsXG4gICAgcHJvZ3JhbTogcHJvZ3JhbSB8fCB7IHdpbmRvd3NLaXQ6IHBhdGguZGlybmFtZShmaW5kU2RrVG9vbCgnbWFrZWNlcnQuZXhlJykpIH0sXG4gIH07XG5cbiAgaWYgKCFpc1ZhbGlkUHVibGlzaGVyTmFtZShwdWJsaXNoZXJOYW1lKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgUmVjZWl2ZWQgaW52YWxpZCBwdWJsaXNoZXIgbmFtZTogJyR7cHVibGlzaGVyTmFtZX0nIGRpZCBub3QgY29uZm9ybSB0byBYLjUwMCBkaXN0aW5ndWlzaGVkIG5hbWUgc3ludGF4IGZvciBNYWtlQ2VydC5gKTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCBtYWtlQ2VydChtYWtlQ2VydE9wdGlvbnMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGlzdGluZ3Vpc2hlZE5hbWVGcm9tQXV0aG9yKGF1dGhvcikge1xuICBsZXQgcHVibGlzaGVyID0gYXV0aG9yIHx8ICcnO1xuXG4gIGlmICh0eXBlb2YgcHVibGlzaGVyID09PSAnc3RyaW5nJykge1xuICAgIHB1Ymxpc2hlciA9IHBhcnNlQXV0aG9yKHB1Ymxpc2hlcik7XG4gIH1cblxuICBpZiAodHlwZW9mIHB1Ymxpc2hlci5uYW1lID09PSAnc3RyaW5nJykge1xuICAgIHB1Ymxpc2hlciA9IHB1Ymxpc2hlci5uYW1lO1xuICB9XG5cbiAgaWYgKHR5cGVvZiBwdWJsaXNoZXIgIT09ICdzdHJpbmcnKSB7XG4gICAgcHVibGlzaGVyID0gJyc7XG4gIH1cblxuICByZXR1cm4gYENOPSR7cHVibGlzaGVyfWA7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jICh7IGRpciwgYXBwTmFtZSwgdGFyZ2V0QXJjaCwgZm9yZ2VDb25maWcsIHBhY2thZ2VKU09OIH0pID0+IHtcbiAgY29uc3Qgb3V0UGF0aCA9IHBhdGgucmVzb2x2ZShkaXIsIGAuLi9tYWtlL2FwcHgvJHt0YXJnZXRBcmNofWApO1xuICBhd2FpdCBlbnN1cmVEaXJlY3Rvcnkob3V0UGF0aCk7XG5cbiAgY29uc3QgdXNlckNvbmZpZyA9IGNvbmZpZ0ZuKGZvcmdlQ29uZmlnLndpbmRvd3NTdG9yZUNvbmZpZywgdGFyZ2V0QXJjaCk7XG5cbiAgY29uc3Qgb3B0cyA9IE9iamVjdC5hc3NpZ24oe1xuICAgIHB1Ymxpc2hlcjogZ2V0RGlzdGluZ3Vpc2hlZE5hbWVGcm9tQXV0aG9yKHBhY2thZ2VKU09OLmF1dGhvciksXG4gICAgZmxhdHRlbjogZmFsc2UsXG4gICAgZGVwbG95OiBmYWxzZSxcbiAgICBwYWNrYWdlVmVyc2lvbjogYCR7cGFja2FnZUpTT04udmVyc2lvbn0uMGAsXG4gICAgcGFja2FnZU5hbWU6IGFwcE5hbWUucmVwbGFjZSgvLS9nLCAnJyksXG4gICAgcGFja2FnZURpc3BsYXlOYW1lOiBhcHBOYW1lLFxuICAgIHBhY2thZ2VEZXNjcmlwdGlvbjogcGFja2FnZUpTT04uZGVzY3JpcHRpb24gfHwgYXBwTmFtZSxcbiAgICBwYWNrYWdlRXhlY3V0YWJsZTogYGFwcFxcXFwke2FwcE5hbWV9LmV4ZWAsXG4gICAgd2luZG93c0tpdDogdXNlckNvbmZpZy53aW5kb3dzS2l0IHx8IHBhdGguZGlybmFtZShmaW5kU2RrVG9vbCgnbWFrZWFwcHguZXhlJykpLFxuICB9LCB1c2VyQ29uZmlnLCB7XG4gICAgaW5wdXREaXJlY3Rvcnk6IGRpcixcbiAgICBvdXRwdXREaXJlY3Rvcnk6IG91dFBhdGgsXG4gIH0pO1xuXG4gIGlmICghb3B0cy5wdWJsaXNoZXIpIHtcbiAgICB0aHJvdyAnUGxlYXNlIHNldCBjb25maWcuZm9yZ2Uud2luZG93c1N0b3JlQ29uZmlnLnB1Ymxpc2hlciBvciBhdXRob3IubmFtZSBpbiBwYWNrYWdlLmpzb24gZm9yIHRoZSBhcHB4IHRhcmdldCc7XG4gIH1cblxuICBpZiAoIW9wdHMuZGV2Q2VydCkge1xuICAgIG9wdHMuZGV2Q2VydCA9IGF3YWl0IGNyZWF0ZURlZmF1bHRDZXJ0aWZpY2F0ZShvcHRzLnB1Ymxpc2hlciwgeyBjZXJ0RmlsZVBhdGg6IG91dFBhdGgsIHByb2dyYW06IG9wdHMgfSk7XG4gIH1cblxuICBpZiAob3B0cy5wYWNrYWdlVmVyc2lvbi5tYXRjaCgvLS8pKSB7XG4gICAgaWYgKG9wdHMubWFrZVZlcnNpb25XaW5TdG9yZUNvbXBhdGlibGUpIHtcbiAgICAgIGNvbnN0IG5vQmV0YSA9IG9wdHMucGFja2FnZVZlcnNpb24ucmVwbGFjZSgvLS4qLywgJycpO1xuICAgICAgb3B0cy5wYWNrYWdlVmVyc2lvbiA9IGAke25vQmV0YX0uMGA7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGVyciA9IFwiV2luZG93cyBTdG9yZSB2ZXJzaW9uIG51bWJlcnMgZG9uJ3Qgc3VwcG9ydCBzZW12ZXIgYmV0YSB0YWdzLiBUb1wiICtcbiAgICAgICAgJ2F1dG9tYXRpY2FsbHkgZml4IHRoaXMsIHNldCBtYWtlVmVyc2lvbldpblN0b3JlQ29tcGF0aWJsZSB0byB0cnVlIG9yICcgK1xuICAgICAgICAnZXhwbGljaXRseSBzZXQgcGFja2FnZVZlcnNpb24gdG8gYSB2ZXJzaW9uIG9mIHRoZSBmb3JtYXQgWC5ZLlouQSc7XG5cbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnIpO1xuICAgIH1cbiAgfVxuXG4gIGRlbGV0ZSBvcHRzLm1ha2VWZXJzaW9uV2luU3RvcmVDb21wYXRpYmxlO1xuXG4gIGF3YWl0IHdpbmRvd3NTdG9yZShvcHRzKTtcblxuICByZXR1cm4gW3BhdGgucmVzb2x2ZShvdXRQYXRoLCBgJHtvcHRzLnBhY2thZ2VOYW1lfS5hcHB4YCldO1xufTtcbiJdfQ==
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _bluebird = require('bluebird');

var _getOwnPropertyDescriptor = require('babel-runtime/core-js/object/get-own-property-descriptor');

var _getOwnPropertyDescriptor2 = _interopRequireDefault(_getOwnPropertyDescriptor);

var _typeof2 = require('babel-runtime/helpers/typeof');

var _typeof3 = _interopRequireDefault(_typeof2);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _lodash = require('lodash.template');

var _lodash2 = _interopRequireDefault(_lodash);

var _readPackageJson = require('./read-package-json');

var _readPackageJson2 = _interopRequireDefault(_readPackageJson);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var underscoreCase = function underscoreCase(str) {
  return str.replace(/(.)([A-Z][a-z]+)/g, '$1_$2').replace(/([a-z0-9])([A-Z])/g, '$1_$2').toUpperCase();
};

var proxify = function proxify(object, envPrefix) {
  var newObject = {};

  (0, _keys2.default)(object).forEach(function (key) {
    if ((0, _typeof3.default)(object[key]) === 'object' && !Array.isArray(object[key])) {
      newObject[key] = proxify(object[key], envPrefix + '_' + underscoreCase(key));
    } else {
      newObject[key] = object[key];
    }
  });

  return new Proxy(newObject, {
    get: function get(target, name) {
      // eslint-disable-next-line no-prototype-builtins
      if (!target.hasOwnProperty(name) && typeof name === 'string') {
        var envValue = process.env[envPrefix + '_' + underscoreCase(name)];
        if (envValue) return envValue;
      }
      return target[name];
    },
    getOwnPropertyDescriptor: function getOwnPropertyDescriptor(target, name) {
      var envValue = process.env[envPrefix + '_' + underscoreCase(name)];
      // eslint-disable-next-line no-prototype-builtins
      if (target.hasOwnProperty(name)) {
        return (0, _getOwnPropertyDescriptor2.default)(target, name);
      } else if (envValue) {
        return { writable: true, enumerable: true, configurable: true, value: envValue };
      }
    }
  });
};

exports.default = function () {
  var _ref = (0, _bluebird.coroutine)( /*#__PURE__*/_regenerator2.default.mark(function _callee(dir) {
    var packageJSON, forgeConfig, templateObj, template;
    return _regenerator2.default.wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            _context.next = 2;
            return (0, _readPackageJson2.default)(dir);

          case 2:
            packageJSON = _context.sent;
            forgeConfig = packageJSON.config.forge;
            _context.t0 = typeof forgeConfig === 'string';

            if (!_context.t0) {
              _context.next = 14;
              break;
            }

            _context.next = 8;
            return _fsExtra2.default.pathExists(_path2.default.resolve(dir, forgeConfig));

          case 8:
            _context.t1 = _context.sent;

            if (_context.t1) {
              _context.next = 13;
              break;
            }

            _context.next = 12;
            return _fsExtra2.default.pathExists(_path2.default.resolve(dir, forgeConfig + '.js'));

          case 12:
            _context.t1 = _context.sent;

          case 13:
            _context.t0 = _context.t1;

          case 14:
            if (!_context.t0) {
              _context.next = 25;
              break;
            }

            _context.prev = 15;

            forgeConfig = require(_path2.default.resolve(dir, forgeConfig));
            _context.next = 23;
            break;

          case 19:
            _context.prev = 19;
            _context.t2 = _context['catch'](15);

            console.error('Failed to load: ' + _path2.default.resolve(dir, forgeConfig));
            throw _context.t2;

          case 23:
            _context.next = 27;
            break;

          case 25:
            if (!((typeof forgeConfig === 'undefined' ? 'undefined' : (0, _typeof3.default)(forgeConfig)) !== 'object')) {
              _context.next = 27;
              break;
            }

            throw new Error('Expected packageJSON.config.forge to be an object or point to a requirable JS file');

          case 27:
            forgeConfig = (0, _assign2.default)({
              make_targets: {},
              publish_targets: {},
              electronPackagerConfig: {},
              electronWinstallerConfig: {},
              electronInstallerDebian: {},
              electronInstallerDMG: {},
              electronInstallerRedhat: {},
              s3: {},
              github_repository: {},
              electronReleaseServer: {}
            }, forgeConfig);
            forgeConfig.make_targets = (0, _assign2.default)({
              win32: ['squirrel'],
              darwin: ['zip'],
              mas: ['zip'],
              linux: ['deb', 'rpm']
            }, forgeConfig.make_targets);
            forgeConfig.publish_targets = (0, _assign2.default)({
              win32: ['github'],
              darwin: ['github'],
              mas: ['github'],
              linux: ['github']
            }, forgeConfig.publish_targets);

            templateObj = (0, _assign2.default)({}, packageJSON, { year: new Date().getFullYear() });

            template = function template(obj) {
              (0, _keys2.default)(obj).forEach(function (objKey) {
                if ((0, _typeof3.default)(obj[objKey]) === 'object' && obj !== null) {
                  template(obj[objKey]);
                } else if (typeof obj[objKey] === 'string') {
                  obj[objKey] = (0, _lodash2.default)(obj[objKey])(templateObj); // eslint-disable-line
                  if (obj[objKey].startsWith('require:')) {
                    obj[objKey] = require(_path2.default.resolve(dir, obj[objKey].substr(8))); // eslint-disable-line
                  }
                }
              });
            };

            template(forgeConfig);

            return _context.abrupt('return', proxify(forgeConfig, 'ELECTRON_FORGE'));

          case 34:
          case 'end':
            return _context.stop();
        }
      }
    }, _callee, undefined, [[15, 19]]);
  }));

  return function (_x) {
    return _ref.apply(this, arguments);
  };
}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWwvZm9yZ2UtY29uZmlnLmpzIl0sIm5hbWVzIjpbInVuZGVyc2NvcmVDYXNlIiwic3RyIiwicmVwbGFjZSIsInRvVXBwZXJDYXNlIiwicHJveGlmeSIsIm9iamVjdCIsImVudlByZWZpeCIsIm5ld09iamVjdCIsImZvckVhY2giLCJrZXkiLCJBcnJheSIsImlzQXJyYXkiLCJQcm94eSIsImdldCIsInRhcmdldCIsIm5hbWUiLCJoYXNPd25Qcm9wZXJ0eSIsImVudlZhbHVlIiwicHJvY2VzcyIsImVudiIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsIndyaXRhYmxlIiwiZW51bWVyYWJsZSIsImNvbmZpZ3VyYWJsZSIsInZhbHVlIiwiZGlyIiwicGFja2FnZUpTT04iLCJmb3JnZUNvbmZpZyIsImNvbmZpZyIsImZvcmdlIiwicGF0aEV4aXN0cyIsInJlc29sdmUiLCJyZXF1aXJlIiwiY29uc29sZSIsImVycm9yIiwiRXJyb3IiLCJtYWtlX3RhcmdldHMiLCJwdWJsaXNoX3RhcmdldHMiLCJlbGVjdHJvblBhY2thZ2VyQ29uZmlnIiwiZWxlY3Ryb25XaW5zdGFsbGVyQ29uZmlnIiwiZWxlY3Ryb25JbnN0YWxsZXJEZWJpYW4iLCJlbGVjdHJvbkluc3RhbGxlckRNRyIsImVsZWN0cm9uSW5zdGFsbGVyUmVkaGF0IiwiczMiLCJnaXRodWJfcmVwb3NpdG9yeSIsImVsZWN0cm9uUmVsZWFzZVNlcnZlciIsIndpbjMyIiwiZGFyd2luIiwibWFzIiwibGludXgiLCJ0ZW1wbGF0ZU9iaiIsInllYXIiLCJEYXRlIiwiZ2V0RnVsbFllYXIiLCJ0ZW1wbGF0ZSIsIm9iaiIsIm9iaktleSIsInN0YXJ0c1dpdGgiLCJzdWJzdHIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUEsSUFBTUEsaUJBQWlCLFNBQWpCQSxjQUFpQjtBQUFBLFNBQU9DLElBQUlDLE9BQUosQ0FB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LG9CQUFJLHNCQUFPRCxJQUFJQyxNQUFKLENBQVAsTUFBdUIsUUFBdkIsSUFBbUNELFFBQVEsSUFBL0MsRUFBcUQ7QUFDbkRELDJCQUFTQyxJQUFJQyxNQUFKLENBQVQ7QUFDRCxpQkFGRCxNQUVPLElBQUksT0FBT0QsSUFBSUMsTUFBSixDQUFQLEtBQXVCLFFBQTNCLEVBQXFDO0FBQzFDRCxzQkFBSUMsTUFBSixJQUFjLHNCQUFVRCxJQUFJQyxNQUFKLENBQVYsRUFBdUJOLFdBQXZCLENBQWQsQ0FEMEMsQ0FDUztBQUNuRCxzQkFBSUssSUFBSUMsTUFBSixFQUFZQyxVQUFaLENBQXVCLFVBQXZCLENBQUosRUFBd0M7QUFDdENGLHdCQUFJQyxNQUFKLElBQWN4QixRQUFRLGVBQUtELE9BQUwsQ0FBYU4sR0FBYixFQUFrQjhCLElBQUlDLE1BQUosRUFBWUUsTUFBWixDQUFtQixDQUFuQixDQUFsQixDQUFSLENBQWQsQ0FEc0MsQ0FDMkI7QUFDbEU7QUFDRjtBQUNGLGVBVEQ7QUFVRCxhQWxEWTs7QUFvRGJKLHFCQUFTM0IsV0FBVDs7QUFwRGEsNkNBc0ROdkIsUUFBUXVCLFdBQVIsRUFBcUIsZ0JBQXJCLENBdERNOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEciLCJmaWxlIjoidXRpbC9mb3JnZS1jb25maWcuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgX3RlbXBsYXRlIGZyb20gJ2xvZGFzaC50ZW1wbGF0ZSc7XG5pbXBvcnQgcmVhZFBhY2thZ2VKU09OIGZyb20gJy4vcmVhZC1wYWNrYWdlLWpzb24nO1xuXG5jb25zdCB1bmRlcnNjb3JlQ2FzZSA9IHN0ciA9PiBzdHIucmVwbGFjZSgvKC4pKFtBLVpdW2Etel0rKS9nLCAnJDFfJDInKS5yZXBsYWNlKC8oW2EtejAtOV0pKFtBLVpdKS9nLCAnJDFfJDInKS50b1VwcGVyQ2FzZSgpO1xuXG5jb25zdCBwcm94aWZ5ID0gKG9iamVjdCwgZW52UHJlZml4KSA9PiB7XG4gIGNvbnN0IG5ld09iamVjdCA9IHt9O1xuXG4gIE9iamVjdC5rZXlzKG9iamVjdCkuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgaWYgKHR5cGVvZiBvYmplY3Rba2V5XSA9PT0gJ29iamVjdCcgJiYgIUFycmF5LmlzQXJyYXkob2JqZWN0W2tleV0pKSB7XG4gICAgICBuZXdPYmplY3Rba2V5XSA9IHByb3hpZnkob2JqZWN0W2tleV0sIGAke2VudlByZWZpeH1fJHt1bmRlcnNjb3JlQ2FzZShrZXkpfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBuZXdPYmplY3Rba2V5XSA9IG9iamVjdFtrZXldO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIG5ldyBQcm94eShuZXdPYmplY3QsIHtcbiAgICBnZXQodGFyZ2V0LCBuYW1lKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcHJvdG90eXBlLWJ1aWx0aW5zXG4gICAgICBpZiAoIXRhcmdldC5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB0eXBlb2YgbmFtZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgY29uc3QgZW52VmFsdWUgPSBwcm9jZXNzLmVudltgJHtlbnZQcmVmaXh9XyR7dW5kZXJzY29yZUNhc2UobmFtZSl9YF07XG4gICAgICAgIGlmIChlbnZWYWx1ZSkgcmV0dXJuIGVudlZhbHVlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRhcmdldFtuYW1lXTtcbiAgICB9LFxuICAgIGdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpIHtcbiAgICAgIGNvbnN0IGVudlZhbHVlID0gcHJvY2Vzcy5lbnZbYCR7ZW52UHJlZml4fV8ke3VuZGVyc2NvcmVDYXNlKG5hbWUpfWBdO1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXByb3RvdHlwZS1idWlsdGluc1xuICAgICAgaWYgKHRhcmdldC5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpO1xuICAgICAgfSBlbHNlIGlmIChlbnZWYWx1ZSkge1xuICAgICAgICByZXR1cm4geyB3cml0YWJsZTogdHJ1ZSwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB2YWx1ZTogZW52VmFsdWUgfTtcbiAgICAgIH1cbiAgICB9LFxuICB9KTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIChkaXIpID0+IHtcbiAgY29uc3QgcGFja2FnZUpTT04gPSBhd2FpdCByZWFkUGFja2FnZUpTT04oZGlyKTtcbiAgbGV0IGZvcmdlQ29uZmlnID0gcGFja2FnZUpTT04uY29uZmlnLmZvcmdlO1xuICBpZiAodHlwZW9mIGZvcmdlQ29uZmlnID09PSAnc3RyaW5nJyAmJiAoYXdhaXQgZnMucGF0aEV4aXN0cyhwYXRoLnJlc29sdmUoZGlyLCBmb3JnZUNvbmZpZykpIHx8IGF3YWl0IGZzLnBhdGhFeGlzdHMocGF0aC5yZXNvbHZlKGRpciwgYCR7Zm9yZ2VDb25maWd9LmpzYCkpKSkge1xuICAgIHRyeSB7XG4gICAgICBmb3JnZUNvbmZpZyA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKGRpciwgZm9yZ2VDb25maWcpKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBsb2FkOiAke3BhdGgucmVzb2x2ZShkaXIsIGZvcmdlQ29uZmlnKX1gKTtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH0gZWxzZSBpZiAodHlwZW9mIGZvcmdlQ29uZmlnICE9PSAnb2JqZWN0Jykge1xuICAgIHRocm93IG5ldyBFcnJvcignRXhwZWN0ZWQgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlIHRvIGJlIGFuIG9iamVjdCBvciBwb2ludCB0byBhIHJlcXVpcmFibGUgSlMgZmlsZScpO1xuICB9XG4gIGZvcmdlQ29uZmlnID0gT2JqZWN0LmFzc2lnbih7XG4gICAgbWFrZV90YXJnZXRzOiB7fSxcbiAgICBwdWJsaXNoX3RhcmdldHM6IHt9LFxuICAgIGVsZWN0cm9uUGFja2FnZXJDb25maWc6IHt9LFxuICAgIGVsZWN0cm9uV2luc3RhbGxlckNvbmZpZzoge30sXG4gICAgZWxlY3Ryb25JbnN0YWxsZXJEZWJpYW46IHt9LFxuICAgIGVsZWN0cm9uSW5zdGFsbGVyRE1HOiB7fSxcbiAgICBlbGVjdHJvbkluc3RhbGxlclJlZGhhdDoge30sXG4gICAgczM6IHt9LFxuICAgIGdpdGh1Yl9yZXBvc2l0b3J5OiB7fSxcbiAgICBlbGVjdHJvblJlbGVhc2VTZXJ2ZXI6IHt9LFxuICB9LCBmb3JnZUNvbmZpZyk7XG4gIGZvcmdlQ29uZmlnLm1ha2VfdGFyZ2V0cyA9IE9iamVjdC5hc3NpZ24oe1xuICAgIHdpbjMyOiBbJ3NxdWlycmVsJ10sXG4gICAgZGFyd2luOiBbJ3ppcCddLFxuICAgIG1hczogWyd6aXAnXSxcbiAgICBsaW51eDogWydkZWInLCAncnBtJ10sXG4gIH0sIGZvcmdlQ29uZmlnLm1ha2VfdGFyZ2V0cyk7XG4gIGZvcmdlQ29uZmlnLnB1Ymxpc2hfdGFyZ2V0cyA9IE9iamVjdC5hc3NpZ24oe1xuICAgIHdpbjMyOiBbJ2dpdGh1YiddLFxuICAgIGRhcndpbjogWydnaXRodWInXSxcbiAgICBtYXM6IFsnZ2l0aHViJ10sXG4gICAgbGludXg6IFsnZ2l0aHViJ10sXG4gIH0sIGZvcmdlQ29uZmlnLnB1Ymxpc2hfdGFyZ2V0cyk7XG5cbiAgY29uc3QgdGVtcGxhdGVPYmogPSBPYmplY3QuYXNzaWduKHt9LCBwYWNrYWdlSlNPTiwgeyB5ZWFyOiAobmV3IERhdGUoKSkuZ2V0RnVsbFllYXIoKSB9KTtcbiAgY29uc3QgdGVtcGxhdGUgPSAob2JqKSA9PiB7XG4gICAgT2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKChvYmpLZXkpID0+IHtcbiAgICAgIGlmICh0eXBlb2Ygb2JqW29iaktleV0gPT09ICdvYmplY3QnICYmIG9iaiAhPT0gbnVsbCkge1xuICAgICAgICB0ZW1wbGF0ZShvYmpbb2JqS2V5XSk7XG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmpbb2JqS2V5XSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgb2JqW29iaktleV0gPSBfdGVtcGxhdGUob2JqW29iaktleV0pKHRlbXBsYXRlT2JqKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICAgICAgICBpZiAob2JqW29iaktleV0uc3RhcnRzV2l0aCgncmVxdWlyZTonKSkge1xuICAgICAgICAgIG9ialtvYmpLZXldID0gcmVxdWlyZShwYXRoLnJlc29sdmUoZGlyLCBvYmpbb2JqS2V5XS5zdWJzdHIoOCkpKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH07XG5cbiAgdGVtcGxhdGUoZm9yZ2VDb25maWcpO1xuXG4gIHJldHVybiBwcm94aWZ5KGZvcmdlQ29uZmlnLCAnRUxFQ1RST05fRk9SR0UnKTtcbn07XG4iXX0=
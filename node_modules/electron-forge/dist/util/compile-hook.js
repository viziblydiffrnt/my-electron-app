'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _bluebird = require('bluebird');

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _oraHandler = require('./ora-handler');

var _oraHandler2 = _interopRequireDefault(_oraHandler);

var _readPackageJson = require('./read-package-json');

var _readPackageJson2 = _interopRequireDefault(_readPackageJson);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

exports.default = function () {
  var _ref = (0, _bluebird.coroutine)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(originalDir, buildPath, electronVersion, pPlatform, pArch, done) {
    return _regenerator2.default.wrap(function _callee3$(_context3) {
      while (1) {
        switch (_context3.prev = _context3.next) {
          case 0:
            _context3.next = 2;
            return (0, _oraHandler2.default)('Compiling Application', (0, _bluebird.coroutine)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {
              var compileAndShim = function () {
                var _ref3 = (0, _bluebird.coroutine)( /*#__PURE__*/_regenerator2.default.mark(function _callee(appDir) {
                  var _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, entry, fullPath, log, packageJSON, index;

                  return _regenerator2.default.wrap(function _callee$(_context) {
                    while (1) {
                      switch (_context.prev = _context.next) {
                        case 0:
                          _iteratorNormalCompletion = true;
                          _didIteratorError = false;
                          _iteratorError = undefined;
                          _context.prev = 3;
                          _context.t0 = _getIterator3.default;
                          _context.next = 7;
                          return _fsExtra2.default.readdir(appDir);

                        case 7:
                          _context.t1 = _context.sent;
                          _iterator = (0, _context.t0)(_context.t1);

                        case 9:
                          if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
                            _context.next = 24;
                            break;
                          }

                          entry = _step.value;

                          if (entry.match(/^(node_modules|bower_components)$/)) {
                            _context.next = 21;
                            break;
                          }

                          fullPath = _path2.default.join(appDir, entry);
                          _context.next = 15;
                          return _fsExtra2.default.stat(fullPath);

                        case 15:
                          if (!_context.sent.isDirectory()) {
                            _context.next = 21;
                            break;
                          }

                          log = console.log;

                          console.log = function () {};
                          _context.next = 20;
                          return compileCLI.main(appDir, [fullPath]);

                        case 20:
                          console.log = log;

                        case 21:
                          _iteratorNormalCompletion = true;
                          _context.next = 9;
                          break;

                        case 24:
                          _context.next = 30;
                          break;

                        case 26:
                          _context.prev = 26;
                          _context.t2 = _context['catch'](3);
                          _didIteratorError = true;
                          _iteratorError = _context.t2;

                        case 30:
                          _context.prev = 30;
                          _context.prev = 31;

                          if (!_iteratorNormalCompletion && _iterator.return) {
                            _iterator.return();
                          }

                        case 33:
                          _context.prev = 33;

                          if (!_didIteratorError) {
                            _context.next = 36;
                            break;
                          }

                          throw _iteratorError;

                        case 36:
                          return _context.finish(33);

                        case 37:
                          return _context.finish(30);

                        case 38:
                          _context.next = 40;
                          return (0, _readPackageJson2.default)(appDir);

                        case 40:
                          packageJSON = _context.sent;
                          index = packageJSON.main || 'index.js';

                          packageJSON.originalMain = index;
                          packageJSON.main = 'es6-shim.js';

                          _context.t3 = _fsExtra2.default;
                          _context.t4 = _path2.default.join(appDir, 'es6-shim.js');
                          _context.next = 48;
                          return _fsExtra2.default.readFile(_path2.default.join(_path2.default.resolve(originalDir, 'node_modules/electron-compile/lib/es6-shim.js')), 'utf8');

                        case 48:
                          _context.t5 = _context.sent;
                          _context.next = 51;
                          return _context.t3.writeFile.call(_context.t3, _context.t4, _context.t5);

                        case 51:
                          _context.next = 53;
                          return _fsExtra2.default.writeFile(_path2.default.join(appDir, 'package.json'), (0, _stringify2.default)(packageJSON, null, 2));

                        case 53:
                        case 'end':
                          return _context.stop();
                      }
                    }
                  }, _callee, this, [[3, 26, 30, 38], [31,, 33, 37]]);
                }));

                return function compileAndShim(_x7) {
                  return _ref3.apply(this, arguments);
                };
              }();

              var compileCLI;
              return _regenerator2.default.wrap(function _callee2$(_context2) {
                while (1) {
                  switch (_context2.prev = _context2.next) {
                    case 0:
                      compileCLI = require(_path2.default.resolve(originalDir, 'node_modules/electron-compile/lib/cli.js'));
                      _context2.next = 3;
                      return compileAndShim(buildPath);

                    case 3:
                    case 'end':
                      return _context2.stop();
                  }
                }
              }, _callee2, undefined);
            })));

          case 2:
            done();

          case 3:
          case 'end':
            return _context3.stop();
        }
      }
    }, _callee3, undefined);
  }));

  return function (_x, _x2, _x3, _x4, _x5, _x6) {
    return _ref.apply(this, arguments);
  };
}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWwvY29tcGlsZS1ob29rLmpzIl0sIm5hbWVzIjpbIm9yaWdpbmFsRGlyIiwiYnVpbGRQYXRoIiwiZWxlY3Ryb25WZXJzaW9uIiwicFBsYXRmb3JtIiwicEFyY2giLCJkb25lIiwiYXBwRGlyIiwicmVhZGRpciIsImVudHJ5IiwibWF0Y2giLCJmdWxsUGF0aCIsImpvaW4iLCJzdGF0IiwiaXNEaXJlY3RvcnkiLCJsb2ciLCJjb25zb2xlIiwiY29tcGlsZUNMSSIsIm1haW4iLCJwYWNrYWdlSlNPTiIsImluZGV4Iiwib3JpZ2luYWxNYWluIiwicmVhZEZpbGUiLCJyZXNvbHZlIiwid3JpdGVGaWxlIiwiY29tcGlsZUFuZFNoaW0iLCJyZXF1aXJlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUNBOzs7Ozs7OytFQUVlLGtCQUFNQSxXQUFOLEVBQW1CQyxTQUFuQixFQUE4QkMsZUFBOUIsRUFBK0NDLFNBQS9DLEVBQTBEQyxLQUExRCxFQUFpRUMsSUFBakU7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsbUJBQ1AsMEJBQVMsdUJBQVQsb0VBQWtDO0FBQUE7QUFBQSw4RkFHdEMsaUJBQThCQyxNQUE5QjtBQUFBOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsaUNBQzRCLGtCQUFHQyxPQUFILENBQVdELE1BQVgsQ0FENUI7O0FBQUE7QUFBQTtBQUFBOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBQ2FFLCtCQURiOztBQUFBLDhCQUVTQSxNQUFNQyxLQUFOLENBQVksbUNBQVosQ0FGVDtBQUFBO0FBQUE7QUFBQTs7QUFHWUMsa0NBSFosR0FHdUIsZUFBS0MsSUFBTCxDQUFVTCxNQUFWLEVBQWtCRSxLQUFsQixDQUh2QjtBQUFBO0FBQUEsaUNBS2lCLGtCQUFHSSxJQUFILENBQVFGLFFBQVIsQ0FMakI7O0FBQUE7QUFBQSw2Q0FLb0NHLFdBTHBDO0FBQUE7QUFBQTtBQUFBOztBQU1jQyw2QkFOZCxHQU1vQkMsUUFBUUQsR0FONUI7O0FBT1FDLGtDQUFRRCxHQUFSLEdBQWMsWUFBTSxDQUFFLENBQXRCO0FBUFI7QUFBQSxpQ0FRY0UsV0FBV0MsSUFBWCxDQUFnQlgsTUFBaEIsRUFBd0IsQ0FBQ0ksUUFBRCxDQUF4QixDQVJkOztBQUFBO0FBU1FLLGtDQUFRRCxHQUFSLEdBQWNBLEdBQWQ7O0FBVFI7QUFBQTtBQUFBO0FBQUE7O0FBQUE7QUFBQTtBQUFBOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBQUE7QUFBQTtBQUFBOztBQUFBO0FBQUE7QUFBQTs7QUFBQTtBQUFBOztBQUFBO0FBQUE7QUFBQTtBQUFBOztBQUFBOztBQUFBO0FBQUE7O0FBQUE7QUFBQTs7QUFBQTtBQUFBO0FBQUEsaUNBYzRCLCtCQUFnQlIsTUFBaEIsQ0FkNUI7O0FBQUE7QUFjUVkscUNBZFI7QUFnQlFDLCtCQWhCUixHQWdCZ0JELFlBQVlELElBQVosSUFBb0IsVUFoQnBDOztBQWlCRUMsc0NBQVlFLFlBQVosR0FBMkJELEtBQTNCO0FBQ0FELHNDQUFZRCxJQUFaLEdBQW1CLGFBQW5COztBQWxCRjtBQUFBLHdDQW9CcUIsZUFBS04sSUFBTCxDQUFVTCxNQUFWLEVBQWtCLGFBQWxCLENBcEJyQjtBQUFBO0FBQUEsaUNBcUJVLGtCQUFHZSxRQUFILENBQVksZUFBS1YsSUFBTCxDQUFVLGVBQUtXLE9BQUwsQ0FBYXRCLFdBQWIsRUFBMEIsK0NBQTFCLENBQVYsQ0FBWixFQUFtRyxNQUFuRyxDQXJCVjs7QUFBQTtBQUFBO0FBQUE7QUFBQSw2Q0FvQld1QixTQXBCWDs7QUFBQTtBQUFBO0FBQUEsaUNBdUJRLGtCQUFHQSxTQUFILENBQ0osZUFBS1osSUFBTCxDQUFVTCxNQUFWLEVBQWtCLGNBQWxCLENBREksRUFFSix5QkFBZVksV0FBZixFQUE0QixJQUE1QixFQUFrQyxDQUFsQyxDQUZJLENBdkJSOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLGlCQUhzQzs7QUFBQSxnQ0FHdkJNLGNBSHVCO0FBQUE7QUFBQTtBQUFBOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFDaENSLGdDQURnQyxHQUNuQlMsUUFBUSxlQUFLSCxPQUFMLENBQWF0QixXQUFiLEVBQTBCLDBDQUExQixDQUFSLENBRG1CO0FBQUE7QUFBQSw2QkErQmhDd0IsZUFBZXZCLFNBQWYsQ0EvQmdDOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLGFBQWxDLEdBRE87O0FBQUE7QUFrQ2JJOztBQWxDYTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxHIiwiZmlsZSI6InV0aWwvY29tcGlsZS1ob29rLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgYXN5bmNPcmEgZnJvbSAnLi9vcmEtaGFuZGxlcic7XG5pbXBvcnQgcmVhZFBhY2thZ2VKU09OIGZyb20gJy4vcmVhZC1wYWNrYWdlLWpzb24nO1xuXG5leHBvcnQgZGVmYXVsdCBhc3luYyhvcmlnaW5hbERpciwgYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gsIGRvbmUpID0+IHtcbiAgYXdhaXQgYXN5bmNPcmEoJ0NvbXBpbGluZyBBcHBsaWNhdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBjb21waWxlQ0xJID0gcmVxdWlyZShwYXRoLnJlc29sdmUob3JpZ2luYWxEaXIsICdub2RlX21vZHVsZXMvZWxlY3Ryb24tY29tcGlsZS9saWIvY2xpLmpzJykpO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gY29tcGlsZUFuZFNoaW0oYXBwRGlyKSB7XG4gICAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGF3YWl0IGZzLnJlYWRkaXIoYXBwRGlyKSkge1xuICAgICAgICBpZiAoIWVudHJ5Lm1hdGNoKC9eKG5vZGVfbW9kdWxlc3xib3dlcl9jb21wb25lbnRzKSQvKSkge1xuICAgICAgICAgIGNvbnN0IGZ1bGxQYXRoID0gcGF0aC5qb2luKGFwcERpciwgZW50cnkpO1xuXG4gICAgICAgICAgaWYgKChhd2FpdCBmcy5zdGF0KGZ1bGxQYXRoKSkuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgY29uc3QgbG9nID0gY29uc29sZS5sb2c7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyA9ICgpID0+IHt9O1xuICAgICAgICAgICAgYXdhaXQgY29tcGlsZUNMSS5tYWluKGFwcERpciwgW2Z1bGxQYXRoXSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyA9IGxvZztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29uc3QgcGFja2FnZUpTT04gPSBhd2FpdCByZWFkUGFja2FnZUpTT04oYXBwRGlyKTtcblxuICAgICAgY29uc3QgaW5kZXggPSBwYWNrYWdlSlNPTi5tYWluIHx8ICdpbmRleC5qcyc7XG4gICAgICBwYWNrYWdlSlNPTi5vcmlnaW5hbE1haW4gPSBpbmRleDtcbiAgICAgIHBhY2thZ2VKU09OLm1haW4gPSAnZXM2LXNoaW0uanMnO1xuXG4gICAgICBhd2FpdCBmcy53cml0ZUZpbGUocGF0aC5qb2luKGFwcERpciwgJ2VzNi1zaGltLmpzJyksXG4gICAgICAgIGF3YWl0IGZzLnJlYWRGaWxlKHBhdGguam9pbihwYXRoLnJlc29sdmUob3JpZ2luYWxEaXIsICdub2RlX21vZHVsZXMvZWxlY3Ryb24tY29tcGlsZS9saWIvZXM2LXNoaW0uanMnKSksICd1dGY4JykpO1xuXG4gICAgICBhd2FpdCBmcy53cml0ZUZpbGUoXG4gICAgICAgIHBhdGguam9pbihhcHBEaXIsICdwYWNrYWdlLmpzb24nKSxcbiAgICAgICAgSlNPTi5zdHJpbmdpZnkocGFja2FnZUpTT04sIG51bGwsIDIpKTtcbiAgICB9XG5cbiAgICBhd2FpdCBjb21waWxlQW5kU2hpbShidWlsZFBhdGgpO1xuICB9KTtcbiAgZG9uZSgpO1xufTtcbiJdfQ==